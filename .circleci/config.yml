version: 2.1

#======================================= Workflows =======================================
workflows:
  version: 2
  build:
    jobs:
      - build_and_pack:
          solution_folder: "Baubit"
          project_name: "Baubit"
          context:
            - Context_Prashant
          filters:
            tags:
              ignore: /.*/ #ignore any builds triggered by tags
            branches:
              only:
                - master
#======================================= End Workflows ===================================

jobs:
  build_and_pack:
    parameters:
      solution_folder:
        type: string
        default: ""
      project_name:
        type: string
        default: ""
      publish_script:
        type: string
        default: "/opt/PackAndPublish.sh"
    docker:
      - image: $DOCKER_HUB_USERNAME/baubit:base
        auth:
            username: $DOCKER_HUB_USERNAME
            password: $DOCKER_HUB_PASSWORD
    steps:
      - run:
          name: Parameter check
          command: |
              # Check all parameters are passed
              if [ -z "<< parameters.solution_folder >>" ]; then
                echo "solution_folder must be passed as a parameter!"
                circleci-agent step halt
              else
                export SOLUTION_FOLDER="<< parameters.solution_folder >>"
              fi

              if [ -z "<< parameters.project_name >>" ]; then
                echo "project_name must be passed as a parameter!"
                circleci-agent step halt
              else
                export PROJECT_NAME="<< parameters.project_name >>"
              fi

              echo "export SOLUTION_FOLDER=$SOLUTION_FOLDER" >> "$BASH_ENV"
              echo "export PROJECT_NAME=$PROJECT_NAME" >> "$BASH_ENV"
      - checkout
      # Step 1: Check for ignored files.
      - run:
          name: Check for ignored files
          command: |            
              # Capture the list of changed files
              CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)

              # Check if only .circleci/config.yml was changed
              if [ "$CHANGED_FILES" = ".circleci/config.yml" ]; then
                  echo "Only .circleci/config.yml was changed. Skipping build."
                  circleci-agent step halt
              elif [ "$CHANGED_FILES" = "README.md" ]; then
                  echo "Only README.md was changed. Skipping build."
                  circleci-agent step halt
              else
                  echo "Changes detected outside of ignored files. Proceeding with build."
              fi

      # Step 2: Add github as a nuget package source
      - run:
          name: Add github as a nuget package source
          command: |
            dotnet nuget add source --username $GITHUB_USERNAME --password $GITHUB_PAT --store-password-in-clear-text --name github "$GITHUB_NUGET_PKG_SOURCE_URL"

      # Step 3: Test
      - run:
          name: Build
          command: |
            PROJECT_FILE="${SOLUTION_FOLDER}/${PROJECT_NAME}.csproj"
                            
            dotnet build ${PROJECT_FILE} --configuration Release --nowarn:9999


      # Step 4: Test
      - run:
          name: Test
          command: |
            SOLUTION_FILE="${SOLUTION_FOLDER}.sln"
                
            dotnet test ${SOLUTION_FILE}


      # Step 5: Pack and publish
      - run:
          name: Pack_and_publish
          command: |
            cp << parameters.publish_script >> ./publish.sh
            chmod +x publish.sh
            ./publish.sh
      
      